---
date: 2019-01-02T14:20:02.374Z
title: Improving the cache performance of The Polyfill Service even more
category: Polyfill.io
---
From December 11th 2018 to December 17th 2018, [polyfill.io](https://polyfill.io) served 1,250,322 requests, 99.98% of which were served from Fastly's cache. To achieve such a high cache-hit ratio, we employed some novel solutions using <abbr title="Varnish Configuration Language">VCL</abbr>. In this blog post I will explain how we went about achieving this result.

## What is polyfill.io and how does it work?

Polyfill.io is a service which serves polyfills for features which are missing in the requesting user-agent. It works by reading the request url to figure out which features the website is wanting to polyfill and then reading the user-agent header to see what features are missing in from the user-agent and serving polyfills for the missing features that were included in the request url.

## How the caching works

Polyfill.io uses [Varnish Cache](https://varnish-cache.org/intro/), specifically it uses [Fastly's Varnish Cache](https://www.fastly.com/blog/benefits-using-varnish). When a request is made to polyfill.io, the Varnish Cache server will handle the request, create a "hash key" and check if an object in it's cache has the corresponding "hash key", if it does then it responds with the cached object.

Varnish Cache is a programmable cache, which is great because it allows us define how to create the "hash key". We decided to use the <abbr title="Uniform Resource Locater">URL</abbr> path and query-parameters as the hash key because they are the interface to our <abbr title="Application Program Interface">API</abbr>. The rest of this post goes into how we made different request <abbr title="Uniform Resource Locater">URL</abbr>s end up being the same <abbr title="Uniform Resource Locater">URL</abbr> before Varnish Cache generates the hash key.

The code used to generate the hash key:

```
sub vcl_hash {
	...
	set req.hash += req.url;
	# We include return(hash) to stop the function falling through to the default VCL built into varnish, which for vcl_hash will add req.url and req.http.Host to the hash.
	return(hash);
}
```

<small>[You can also view the code on GitHub](https://github.com/Financial-Times/polyfill-service/blob/714623bdfff470b865c0e6f7746db5f6908f3acc/fastly/vcl/polyfill-service.vcl#L88-L98)</small>

## Normalising the query parameters

The API for configuring a polyfill bundle is available via the query paramter. I.E. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded` is configuring the polyfill bundle to contain polyfills for [`fetch`](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch), [`IntersectionObserver`](https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver), and to call `polyfillsLoaded` once done.

There are many ways to configure this exact same polyfill bundle.\
A non-exhaustive list:

1. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded`
2. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
3. `polyfill.io/v3/polyfill.js?features=fetch,IntersectionObserver&callback=polyfillsLoaded`
4. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=fetch,IntersectionObserver`
5. `polyfill.io/v3/polyfill.js?features=fetch,IntersectionObserver&callback=polyfillsLoaded&zebra=striped`
6. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded&unknown=polyfill`

We want to be able to have all these different URLs use the same hash key, the way to do that is to get them all to have the same URL before the Varnish Cache creates the key.

If you look at the list of URLs you might notice that some of them have the exact same query parameters but in a different order. We can re-order the query parameters with a function that Fastly provide called [`querystring.sort`](https://docs.fastly.com/vcl/functions/querystring-sort/). Using just this function will make URLs 1 and 2 become the same as well as 3 and 4.

<script type="application/json+fiddle">
{
  "title": "Sorting Querystrings",
  "origins": [
    "https://polyfill.io"
  ],
  "vcl": {
    "recv": "# Store original url for logging purposes.\ndeclare local var.original-url STRING;\nset var.original-url = req.url;\n\nset req.url = querystring.sort(req.url);\n\nlog \"Original url: \" var.original-url;\nlog \"Updated  url: \" req.url;"
  },
  "reqUrl": "/v3/polyfill.js?features=fetch%2CIntersectionObserver&callback=polyfillsLoaded&zebra=striped",
  "reqMethod": "GET",
  "purgeFirst": true,
  "enableCluster": false,
  "enableShield": false
}
</script>

Listing the URLs again, now with the query parameters sorted:

1. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
2. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
3. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=fetch,IntersectionObserver`
4. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=fetch,IntersectionObserver`
5. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=fetch,IntersectionObserver&zebra=striped`
6. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded&unknown=polyfill`

Looking again at the list of URLs you might notice that the difference between 2. and 3. is the order the comma-separated features in the features parameter. We would need to sort those features by some manner in order to make them identical. Neither Varnish Cache not Fastly offer a pre-built function to sort a string, VCL also does not have a way to loop through items either. The way we solved this issue was by creating a function which takes a comma-separated string and turn it into a URL where each item in the comma-separated string is a query parameter, that way we can use the same `querystring.sort` function that we used earlier, we then turn the query parameters back into a comma-separated string.

Here is what that function looks like:

<script type="application/json+fiddle">
{
  "title": "Sorting CSVs",
  "origins": [
    "https://polyfill.io"
  ],
  "vcl": {
    "init": "sub sort_comma_separated_value {\n  # This function takes a CSV and tranforms it into a url where each\n  # comma-separated-value is a query-string parameter and then uses \n  # Fastly's querystring.sort function to sort the values. Once sorted\n  # it then turn the query-parameters back into a CSV.\n  # Set the CSV on the header `Sort-Value`.\n  # Returns the sorted CSV on the header `Sorted-Value`.\n\tdeclare local var.value STRING;\n\tset var.value = req.http.Sort-value;\n\n\t# If query value does not exist or is empty, set it to \"\"\n\tset var.value = if(var.value != \"\", var.value, \"\");\n\n\t# Replace all `&` characters with `^`, this is because `&` would break the value up into pieces.\n\tset var.value = regsuball(var.value, \"&\", \"^\");\n\n\t# Replace all `,` characters with `&` to break them into individual query values\n\t# Append `1-` infront of all the query values to make them simpler to transform later\n\tset var.value = \"1-\" regsuball(var.value, \",\", \"&1-\");\n\t\n\t# Create a url-like string in order for querystring.sort to work.\n\tset var.value = querystring.sort(\"https://www.example.com?\" var.value);\n\n\t# Grab all the query values from the sorted url\n\tset var.value = regsub(var.value, \"https://www.example.com\\?\", \"\");\n\t\n\t# Reverse all the previous transformations to get back the single `features` query value value\n\tset var.value = regsuball(var.value, \"1-\", \"\");\n\tset var.value = regsuball(var.value, \"&\", \",\");\n\tset var.value = regsuball(var.value, \"\\^\", \"&\");\n\n\tset req.http.Sorted-Value = var.value;\n}",
    "recv": "# Store original url for logging purposes.\ndeclare local var.original-url STRING;\nset var.original-url = req.url;\n\nif (req.url.qs ~ \"(?i)[^&=]*features=([^&]+)\") {\n  # Need to decode %2C into ,\n  set req.http.Sort-Value = urldecode(re.group.1);\n  call sort_comma_separated_value;\n  set req.url = querystring.set(req.url, \"features\", req.http.Sorted-Value);\n}\n\nset req.url = querystring.sort(req.url);\n\nlog \"Original url: \" var.original-url;\nlog \"Updated  url: \" req.url;"
  },
  "reqUrl": "/v3/polyfill.js?features=fetch%2CIntersectionObserver&callback=polyfillsLoaded&zebra=striped",
  "reqMethod": "GET",
  "purgeFirst": true,
  "enableCluster": false,
  "enableShield": false
}
</script>

<small>[You can also view the code on GitHub](https://github.com/Financial-Times/polyfill-service/blob/714623bdfff470b865c0e6f7746db5f6908f3acc/fastly/vcl/main.vcl#L3-L25)</small>

Using this function will make URLs 1, 2, 3 and 4 identical.

Listing the URLs again, after this function has been used:

1. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
2. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
3. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
4. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
5. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch&zebra=striped`
6. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded&unknown=polyfill`

The 5th URL has configured `zebra` to `striped`, `zebra` is not part of the API for configuring a polyfill bundle. Let's add a function to only keep query parameters in the URL which are actually part of the public API. We can achieve this with a function that Fastly provide called [`querystring.regfilter_except`](https://docs.fastly.com/vcl/functions/querystring-regfilter-except/). Using this function will make URLs 1, 2, 3, 4, and 5 become identical.

<script type="application/json+fiddle">
{
  "title": "Keep query parameters which are part of the API",
  "origins": [
    "https://polyfill.io"
  ],
  "vcl": {
    "recv": "# Store original url for logging purposes.\ndeclare local var.original-url STRING;\nset var.original-url = req.url;\n\n# Remove all querystring parameters which are not part of the public API.\nset req.url = querystring.regfilter_except(req.url, \"^(features|excludes|rum|unknown|flags|version|ua|callback|compression)$\");\n\nlog \"Original url: \" var.original-url;\nlog \"Updated  url: \" req.url;"
  },
  "reqUrl": "/v3/polyfill.js?features=fetch%2CIntersectionObserver&callback=polyfillsLoaded&zebra=striped",
  "reqMethod": "GET",
  "purgeFirst": false,
  "enableCluster": true,
  "enableShield": false
}
</script>

Listing the URLs again, after this function has been used:

1. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
2. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
3. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
4. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
5. `polyfill.io/v3/polyfill.js?callback=polyfillsLoaded&features=IntersectionObserver,fetch`
6. `polyfill.io/v3/polyfill.js?features=IntersectionObserver,fetch&callback=polyfillsLoaded&unknown=polyfill`


The 6th URL has set `unknown` to `polyfill` which just so happens to be the same as the default value for `unknown`. If we add the default values into the URL for the parameters which have not been set, we can make all the URLs in the list become identical. Remember, we use the URL as the hash key within Fastly, making these requests use the same URL internally will mean that they point to the same response in the cache, which is what we are trying to achieve.

<script type="application/json+fiddle">
{
  "title": "Setting default values, removing non-api parameters, sorting CSVs, and sorting querystring",
  "origins": [
    "https://polyfill.io"
  ],
  "vcl": {
    "recv": "# Store original url for logging purposes.\ndeclare local var.original-url STRING;\nset var.original-url = req.url;\n\t\ncall normalise_querystring_parameters_for_polyfill_bundle;\nset req.url = querystring.sort(req.url);\n\nlog \"Original url: \" var.original-url;\nlog \"Updated  url: \" req.url;",
    "init": "sub normalise_querystring_parameters_for_polyfill_bundle {\n\t# Remove all querystring parameters which are not part of the public API.\n\tset req.url = querystring.regfilter_except(req.url, \"^(features|excludes|rum|unknown|flags|version|ua|callback|compression)$\");\n\n\t# (?i) makes the regex case-insensitive\n\t# The regex will match only if their are characters after `features=` which are not an ampersand (&).\n\tif (req.url.qs ~ \"(?i)[^&=]*features=([^&]+)\") {\n\t\t# Parameter has already been set, use the already set value.\n\t\t# re.group.1 is the first regex capture group in the regex above.\n\t\tif (std.strlen(re.group.1) < 100) {\n\t\t\t# We add the value of the features parameter to this header\n\t\t\t# This is to be able to have sort_comma_separated_value sort the value\n\t\t\tset req.http.Sort-Value = urldecode(re.group.1);\n\t\t\tcall sort_comma_separated_value;\n\t\t\t# The header Sorted-Parameter now contains the sorted version of the features parameter.\n\t\t\tset req.url = querystring.set(req.url, \"features\", req.http.Sorted-Value);\n\t\t}\n\t} else {\n\t\t# Parameter has not been set, use the default value.\n\t\tset req.url = querystring.set(req.url, \"features\", \"default\");\n\t}\n\t\n\t# (?i) makes the regex case-insensitive\n\t# The regex will match only if their are characters after `excludes=` which are not an ampersand (&).\n\tif (req.url.qs ~ \"(?i)[^&=]*excludes=([^&]+)\") {\n\t\t# Parameter has already been set, use the already set value.\n\t\t# re.group.1 is the first regex capture group in the regex above.\n\t\tif (std.strlen(re.group.1) < 100) {\n\t\t\t# We add the value of the excludes parameter to this header\n\t\t\t# This is to be able to have sort_comma_separated_value sort the value\n\t\t\tset req.http.Sort-Value = urldecode(re.group.1);\n\t\t\tcall sort_comma_separated_value;\n\t\t\t# The header Sorted-Parameter now contains the sorted version of the excludes parameter.\n\t\t\tset req.url = querystring.set(req.url, \"excludes\", req.http.Sorted-Value);\n\t\t}\n\t} else {\n\t\t# If excludes is not set, set to default value \"\"\n\t\tset req.url = querystring.filter(req.url, \"excludes\");\n\t\tset req.url = if(req.url ~ \"\\?\", req.url \"&excludes=\", req.url \"?excludes=\");\n\t}\n\t\n\t# If rum is not set, set to default value \"0\"\n\tif (req.url.qs !~ \"(?i)[^&=]*rum=([^&]+)\") {\n\t\tset req.url = querystring.set(req.url, \"rum\", \"0\");\n\t}\n\t\n\t# If unknown is not set, set to default value \"polyfill\"\n\tif (req.url.qs !~ \"(?i)[^&=]*unknown=([^&]+)\") {\n\t\tset req.url = querystring.set(req.url, \"unknown\", \"polyfill\");\n\t}\n\n\t# If flags is not set, set to default value \"\"\n\tif (req.url.qs !~ \"(?i)[^&=]*flags=([^&]+)\") {\n\t\tset req.url = querystring.filter(req.url, \"flags\");\n\t\tset req.url = if(req.url ~ \"\\?\", req.url \"&flags=\", req.url \"?flags=\");\n\t}\n\n\t# If version is not set, set to default value \"\"\n\tdeclare local var.version STRING;\n\tif (req.url.qs !~ \"(?i)[^&=]*version=([^&]+)\") {\n\t\tset req.url = querystring.filter(req.url, \"version\");\n\t\tset req.url = if(req.url ~ \"\\?\", req.url \"&version=\", req.url \"?version=\");\n\t}\n\t\n\t# If ua is not set, normalise the User-Agent header based upon the version of the polyfill-library that has been requested.\n\tif (req.url.qs !~ \"(?i)[^&=]*ua=([^&]+)\") {\n\t\tif (req.url.qs ~ \"(?i)[^&=]*version=3\\.25\\.1(&|$)\") {\n\t\t\t# normalise_user_agent function is too large for Fastly Fiddle.\n\t\t\t# call normalise_user_agent;\n\t\t} else {\n\t\t\t# normalise_user_agent_latest function is too large for Fastly Fiddle.\n\t\t\t# call normalise_user_agent_latest;\n\t\t}\n\t\tset req.url = querystring.set(req.url, \"ua\", req.http.Normalized-User-Agent);\n\t}\n\n\t# If callback is not set, set to default value \"\"\n\tif (req.url.qs !~ \"(?i)[^&=]*callback=([^&]+)\") {\n\t\tset req.url = querystring.filter(req.url, \"callback\");\n\t\tset req.url = if(req.url ~ \"\\?\", req.url \"&callback=\", req.url \"?callback=\");\n\t}\n\t\n\t# If compression is not set, use the best compression that the user-agent supports.\n\tif (req.url.qs !~ \"(?i)[^&=]*compression=([^&]+)\") {\n\t\t# When Fastly adds Brotli into the Accept-Encoding normalisation we can replace this with: \n\t\t# `set req.url = querystring.set(req.url, \"compression\", req.http.Accept-Encoding || \"\")`\n\n\t\t# Before SP2, IE/6 doesn't always read and cache gzipped content correctly.\n\t\tif (req.http.Fastly-Orig-Accept-Encoding && req.http.User-Agent !~ \"MSIE 6\") {\n\t\t\tif (req.http.Fastly-Orig-Accept-Encoding ~ \"br\") {\n\t\t\t\tset req.url = querystring.set(req.url, \"compression\", \"br\");\n\t\t\t} elsif (req.http.Fastly-Orig-Accept-Encoding ~ \"gzip\") {\n\t\t\t\tset req.url = querystring.set(req.url, \"compression\", \"gzip\");\n\t\t\t} else {\n\t\t\t\tset req.url = querystring.set(req.url, \"compression\", \"\");\n\t\t\t}\n\t\t} else {\n\t\t\tset req.url = querystring.set(req.url, \"compression\", \"\");\n\t\t}\n\t}\n}\n\nsub sort_comma_separated_value {\n\t# This function takes a CSV and tranforms it into a url where each\n\t# comma-separated-value is a query-string parameter and then uses \n\t# Fastly's querystring.sort function to sort the values. Once sorted\n\t# it then turn the query-parameters back into a CSV.\n\t# Set the CSV on the header `Sort-Value`.\n\t# Returns the sorted CSV on the header `Sorted-Value`.\n\tdeclare local var.value STRING;\n\tset var.value = req.http.Sort-value;\n\n\t# If query value does not exist or is empty, set it to \"\"\n\tset var.value = if(var.value != \"\", var.value, \"\");\n\n\t# Replace all `&` characters with `^`, this is because `&` would break the value up into pieces.\n\tset var.value = regsuball(var.value, \"&\", \"^\");\n\n\t# Replace all `,` characters with `&` to break them into individual query values\n\t# Append `1-` infront of all the query values to make them simpler to transform later\n\tset var.value = \"1-\" regsuball(var.value, \",\", \"&1-\");\n\t\n\t# Create a querystring-like string in order for querystring.sort to work.\n\tset var.value = querystring.sort(\"?\" var.value);\n\n\t# Grab all the query values from the sorted url\n\tset var.value = regsub(var.value, \"\\?\", \"\");\n\t\n\t# Reverse all the previous transformations to get back the single `features` query value value\n\tset var.value = regsuball(var.value, \"1-\", \"\");\n\tset var.value = regsuball(var.value, \"&\", \",\");\n\tset var.value = regsuball(var.value, \"\\^\", \"&\");\n\n\tset req.http.Sorted-Value = var.value;\n}"
  },
  "reqUrl": "/v3/polyfill.js?features=IntersectionObserver%2Cfetch&callback=&zebra=striped",
  "reqMethod": "GET",
  "purgeFirst": true,
  "enableCluster": false,
  "enableShield": false
}
</script>

With all these functions in place the end result is that all 6 of those URLs become identical, which means they will have the same hash key inside Varnish Cache and therefore all point to the same single cached response, increasing the cache-hit ratio and decreasing the amount of requests that need to go all the way back to servers for polyfill.io.

## Normalising the user-agent header inside Varnish Cache

In the previous section I omitted the fact that one of the options in the API is to set the User-Agent in the URL via the `ua` query parameter. This is a very important feature with regards to caching because it means that we can have a different cached entry for each User-Agent making a request. If you are thinking that will be lots of cache entries and make the cache-hit ratio really low, you would be correct. The reason that would happen is because User-Agent values *vary a lot*, [whatismybrowser.com](https://developers.whatismybrowser.com/useragents/explore/) has collected 840,000 unique user-agents and keeps finding new ones every day.

Luckily for polyfill.io we only care about the User-Agent family, major, and minor version. In polyfill.io v1 and v2 we had an API endpoint that would take a User-Agent and return a version of it which was contained only the family, major, and minor version. This worked very well but introduced some complications in the VCL because the API endpoint was implemented in the polyfill.io server it meant that a request without a `ua` query parameter would need to first go to this endpoint to find out it's normalised user-agent value and then go to it's original destination to return a polyfill bundle.

In v3 we have implemented this API endpoint as a function in VCL, which has removed those complications around making two requests to the polyfill.io server. The way that we parse user-agents is by compiling the [uaparser.org](https://www.uaparser.org/) into VCL for the polyfill.io service and into JS for the [polyfill-library](https://github.com/Financial-Times/polyfill-library) npm package.

<script type="application/json+fiddle">
{
  "title": "Parsing user-agent into family, major, and minor",
  "origins": [
    "https://polyfill.io"
  ],
  "vcl": {
    "recv": "call useragent_parser;\n\nlog \"Family: \" req.http.useragent_parser_family;\nlog \"Major: \" req.http.useragent_parser_major;\nlog \"Minor: \" req.http.useragent_parser_minor;\nlog \"Patch: \" req.http.useragent_parser_patch;",
    "init": "sub useragent_parser {\n  declare local var.Family STRING;\n  set var.Family = \"Other\";\n  declare local var.Major STRING;\n  set var.Major = \"\";\n  declare local var.Minor STRING;\n  set var.Minor = \"\";\n  declare local var.Patch STRING;\n  set var.Patch = \"\";\n  if (!req.http.User-Agent) {\n  } else if (req.http.User-Agent ~ \"(ESPN)[%20| ]+Radio/(\\d+)\\.(\\d+)\\.(\\d+) CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Antenna)/(\\d+) CFNetwork\") {\n\t\tset var.Family = \"AntennaPod\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(TopPodcasts)Pro/(\\d+) CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MusicDownloader)Lite/(\\d+)\\.(\\d+)\\.(\\d+) CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(.*)-iPad/(\\d+)\\.?(\\d+)?.?(\\d+)?.?(\\d+)? CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(.*)-iPhone/(\\d+)\\.?(\\d+)?.?(\\d+)?.?(\\d+)? CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(.*)/(\\d+)\\.?(\\d+)?.?(\\d+)?.?(\\d+)? CFNetwork\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(espn\\.go)\") {\n\t\tset var.Family = \"ESPN\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(espnradio\\.com)\") {\n\t\tset var.Family = \"ESPN\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"ESPN APP$\") {\n\t\tset var.Family = \"ESPN\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(audioboom\\.com)\") {\n\t\tset var.Family = \"AudioBoom\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \" (Rivo) RHYTHM\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(CFNetwork)(?:/(\\d+)\\.(\\d+)\\.?(\\d+)?)?\") {\n\t\tset var.Family = \"CFNetwork\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Pingdom.com_bot_version_)(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"PingdomBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PingdomTMS)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"PingdomBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(NewRelicPinger)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"NewRelicPingerBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Tableau)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Tableau\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(\\(StatusCake\\))\") {\n\t\tset var.Family = \"StatusCakeBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(facebookexternalhit)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"FacebookBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Google.*/\\+/web/snippet\") {\n\t\tset var.Family = \"GooglePlusBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"via ggpht.com GoogleImageProxy\") {\n\t\tset var.Family = \"GmailImageProxy\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Twitterbot)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"TwitterBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"/((?:Ant-)?Nutch|[A-z]+[Bb]ot|[A-z]+[Ss]pider|Axtaris|fetchurl|Isara|ShopSalad|Tailsweep)[ \\-](\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\b(008|Altresium|Argus|BaiduMobaider|BoardReader|DNSGroup|DataparkSearch|EDI|Goodzer|Grub|INGRID|Infohelfer|LinkedInBot|LOOQ|Nutch|PathDefender|Peew|PostPost|Steeler|Twitterbot|VSE|WebCrunch|WebZIP|Y!J-BR[A-Z]|YahooSeeker|envolk|sproose|wminer)/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MSIE) (\\d+)\\.(\\d+)([a-z]\\d?)?;.* MSIECrawler\") {\n\t\tset var.Family = \"MSIECrawler\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(DAVdroid)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Google-HTTP-Java-Client|Apache-HttpClient|Go-http-client|scalaj-http|http%20client|Python-urllib|HttpMonitor|TLSProber|WinHTTP|JNLP|okhttp|aihttp|reqwest)(?:[ /](\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Pinterest(?:bot)?)/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?[;\\s\\(]+\\+https://www.pinterest.com/bot.html\") {\n\t\tset var.Family = \"Pinterestbot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(1470\\.net crawler|50\\.nu|8bo Crawler Bot|Aboundex|Accoona-[A-z]+-Agent|AdsBot-Google(?:-[a-z]+)?|altavista|AppEngine-Google|archive.*?\\.org_bot|archiver|Ask Jeeves|[Bb]ai[Dd]u[Ss]pider(?:-[A-Za-z]+)*|bingbot|BingPreview|blitzbot|BlogBridge|Bloglovin|BoardReader(?: [A-Za-z]+)*|boitho.com-dc|BotSeer|BUbiNG|\\b\\w*favicon\\w*\\b|\\bYeti(?:-[a-z]+)?|Catchpoint(?: bot)?|[Cc]harlotte|Checklinks|clumboot|Comodo HTTP\\(S\\) Crawler|Comodo-Webinspector-Crawler|ConveraCrawler|CRAWL-E|CrawlConvera|Daumoa(?:-feedfetcher)?|Feed Seeker Bot|Feedbin|findlinks|Flamingo_SearchEngine|FollowSite Bot|furlbot|Genieo|gigabot|GomezAgent|gonzo1|(?:[a-zA-Z]+-)?Googlebot(?:-[a-zA-Z]+)?|Google SketchUp|grub-client|gsa-crawler|heritrix|HiddenMarket|holmes|HooWWWer|htdig|ia_archiver|ICC-Crawler|Icarus6j|ichiro(?:/mobile)?|IconSurf|IlTrovatore(?:-Setaccio)?|InfuzApp|Innovazion Crawler|InternetArchive|IP2[a-z]+Bot|jbot\\b|KaloogaBot|Kraken|Kurzor|larbin|LEIA|LesnikBot|Linguee Bot|LinkAider|LinkedInBot|Lite Bot|Llaut|lycos|Mail\\.RU_Bot|masscan|masidani_bot|Mediapartners-Google|Microsoft .*? Bot|mogimogi|mozDex|MJ12bot|msnbot(?:-media *)?|msrbot|Mtps Feed Aggregation System|netresearch|Netvibes|NewsGator[^/]*|^NING|Nutch[^/]*|Nymesis|ObjectsSearch|Orbiter|OOZBOT|PagePeeker|PagesInventory|PaxleFramework|Peeplo Screenshot Bot|PlantyNet_WebRobot|Pompos|Qwantify|Read%20Later|Reaper|RedCarpet|Retreiver|Riddler|Rival IQ|scooter|Scrapy|Scrubby|searchsight|seekbot|semanticdiscovery|SemrushBot|Simpy|SimplePie|SEOstats|SimpleRSS|SiteCon|Slackbot-LinkExpanding|Slack-ImgProxy|Slurp|snappy|Speedy Spider|Squrl Java|Stringer|TheUsefulbot|ThumbShotsBot|Thumbshots\\.ru|Tiny Tiny RSS|TwitterBot|WhatsApp|URL2PNG|Vagabondo|VoilaBot|^vortex|Votay bot|^voyager|WASALive.Bot|Web-sniffer|WebThumb|WeSEE:[A-z]+|WhatWeb|WIRE|WordPress|Wotbox|www\\.almaden\\.ibm\\.com|Xenu(?:.s)? Link Sleuth|Xerka [A-z]+Bot|yacy(?:bot)?|Yahoo[a-z]*Seeker|Yahoo! Slurp|Yandex\\w+|YodaoBot(?:-[A-z]+)?|YottaaMonitor|Yowedo|^Zao|^Zao-Crawler|ZeBot_www\\.ze\\.bz|ZooShot|ZyBorg)(?:[ /]v?(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\b(Boto3?|JetS3t|aws-(?:cli|sdk-(?:cpp|go|java|nodejs|ruby2?))|s3fs)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(?:\\/[A-Za-z0-9\\.]+)? *([A-Za-z0-9 \\-_\\!\\[\\]:]*(?:[Aa]rchiver|[Ii]ndexer|[Ss]craper|[Bb]ot|[Ss]pider|[Cc]rawl[a-z]*))/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(?:\\/[A-Za-z0-9\\.]+)? *([A-Za-z0-9 _\\!\\[\\]:]*(?:[Aa]rchiver|[Ii]ndexer|[Ss]craper|[Bb]ot|[Ss]pider|[Cc]rawl[a-z]*)) (\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"((?:[A-z0-9]+|[A-z\\-]+ ?)?(?: the )?(?:[Ss][Pp][Ii][Dd][Ee][Rr]|[Ss]crape|[A-Za-z0-9-]*(?:[^C][^Uu])[Bb]ot|[Cc][Rr][Aa][Ww][Ll])[A-z0-9]*)(?:(?:[ /]| v)(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(HbbTV)/(\\d+)\\.(\\d+)\\.(\\d+) \\(\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Chimera|SeaMonkey|Camino|Waterfox)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+[a-z]*)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\[FB.*;(FBAV)/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = \"Facebook\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\[(Pinterest)/[^\\]]+\\]\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Pinterest)(?: for Android(?: Tablet)?)?/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Mozilla.*Mobile.*(Instagram).(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Mozilla.*Mobile.*(Flipboard).(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Mozilla.*Mobile.*(Flipboard-Briefing).(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Mozilla.*Mobile.*(Onefootball)\\/Android.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+) Basilisk/(\\d+)\") {\n\t\tset var.Family = \"Basilisk\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PaleMoon)/(\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = \"Pale Moon\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Fennec)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+[a-z]*)\") {\n\t\tset var.Family = \"Firefox Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Fennec)/(\\d+)\\.(\\d+)(pre)\") {\n\t\tset var.Family = \"Firefox Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Fennec)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Firefox Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(?:Mobile|Tablet);.*(Firefox)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Firefox Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Namoroka|Shiretoko|Minefield)/(\\d+)\\.(\\d+)\\.(\\d+(?:pre)?)\") {\n\t\tset var.Family = \"Firefox (\" re.group.1 \")\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)(a\\d+[a-z]*)\") {\n\t\tset var.Family = \"Firefox Alpha\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)(b\\d+[a-z]*)\") {\n\t\tset var.Family = \"Firefox Beta\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)-(?:\\d+\\.\\d+)?/(\\d+)\\.(\\d+)(a\\d+[a-z]*)\") {\n\t\tset var.Family = \"Firefox Alpha\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)-(?:\\d+\\.\\d+)?/(\\d+)\\.(\\d+)(b\\d+[a-z]*)\") {\n\t\tset var.Family = \"Firefox Beta\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Namoroka|Shiretoko|Minefield)/(\\d+)\\.(\\d+)([ab]\\d+[a-z]*)?\") {\n\t\tset var.Family = \"Firefox (\" re.group.1 \")\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox).*Tablet browser (\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"MicroB\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MozillaDeveloperPreview)/(\\d+)\\.(\\d+)([ab]\\d+[a-z]*)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(FxiOS)/(\\d+)\\.(\\d+)(\\.(\\d+))?(\\.(\\d+))?\") {\n\t\tset var.Family = \"Firefox iOS\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Flock)/(\\d+)\\.(\\d+)(b\\d+?)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(RockMelt)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Navigator)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Netscape\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Navigator)/(\\d+)\\.(\\d+)([ab]\\d+)\") {\n\t\tset var.Family = \"Netscape\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Netscape6)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+)?\") {\n\t\tset var.Family = \"Netscape\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MyIBrow)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"My Internet Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(UC? ?Browser|UCWEB|U3)[ /]?(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"UC Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Opera Tablet).*Version/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Opera Mini)(?:/att)?/?(\\d+)?(?:\\.(\\d+))?(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Opera)/.+Opera Mobi.+Version/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Opera Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Opera)/(\\d+)\\.(\\d+).+Opera Mobi\") {\n\t\tset var.Family = \"Opera Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Opera Mobi.+(Opera)(?:/|\\s+)(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Opera Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Opera Mobi\") {\n\t\tset var.Family = \"Opera Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Opera)/9.80.*Version/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(?:Mobile Safari).*(OPR)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Opera Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(?:Chrome).*(OPR)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Opera\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Coast)/(\\d+).(\\d+).(\\d+)\") {\n\t\tset var.Family = \"Opera Coast\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(OPiOS)/(\\d+).(\\d+).(\\d+)\") {\n\t\tset var.Family = \"Opera Mini\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Chrome/.+( MMS)/(\\d+).(\\d+).(\\d+)\") {\n\t\tset var.Family = \"Opera Neon\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(hpw|web)OS/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"webOS Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(luakit)\") {\n\t\tset var.Family = \"LuaKit\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Snowshoe)/(\\d+)\\.(\\d+).(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Gecko/\\d+ (Lightning)/(\\d+)\\.(\\d+)\\.?((?:[ab]?\\d+[a-z]*)|(?:\\d*))\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)\\.(\\d+(?:pre)?) \\(Swiftfox\\)\") {\n\t\tset var.Family = \"Swiftfox\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)([ab]\\d+[a-z]*)? \\(Swiftfox\\)\") {\n\t\tset var.Family = \"Swiftfox\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(rekonq)/(\\d+)\\.(\\d+)\\.?(\\d+)? Safari\") {\n\t\tset var.Family = \"Rekonq\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"rekonq\") {\n\t\tset var.Family = \"Rekonq\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(conkeror|Conkeror)/(\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = \"Conkeror\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(konqueror)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Konqueror\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(WeTab)-Browser\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Comodo_Dragon)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Comodo Dragon\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Symphony) (\\d+).(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"PLAYSTATION 3.+WebKit\") {\n\t\tset var.Family = \"NetFront NX\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"PLAYSTATION 3\") {\n\t\tset var.Family = \"NetFront\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PlayStation Portable)\") {\n\t\tset var.Family = \"NetFront\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PlayStation Vita)\") {\n\t\tset var.Family = \"NetFront NX\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"AppleWebKit.+ (NX)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"NetFront NX\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Nintendo 3DS)\") {\n\t\tset var.Family = \"NetFront NX\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Silk)/(\\d+)\\.(\\d+)(?:\\.([0-9\\-]+))?\") {\n\t\tset var.Family = \"Amazon Silk\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Puffin)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Windows Phone .*(Edge)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Edge Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(SamsungBrowser)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Samsung Internet\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(SznProhlizec)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Seznam prohl%u00ED%u017Ee%u010D\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(coc_coc_browser)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Coc Coc\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(baidubrowser)[/\\s](\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?\") {\n\t\tset var.Family = \"Baidu Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(FlyFlow)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Baidu Explorer\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MxBrowser)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Maxthon\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Crosswalk)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"; wv\\).+(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Chrome Mobile WebView\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(CrMo)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Chrome Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(CriOS)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Chrome Mobile iOS\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+) Mobile(?:[ /]|$)\") {\n\t\tset var.Family = \"Chrome Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \" Mobile .*(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Chrome Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(chromeframe)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Chrome Frame\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(SLP Browser)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Tizen Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(SE 2\\.X) MetaSr (\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Sogou Explorer\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MQQBrowser/Mini)(?:(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = \"QQ Browser Mini\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MQQBrowser)(?:/(\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = \"QQ Browser Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(QQBrowser)(?:/(\\d+)(?:\\.(\\d+)\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = \"QQ Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Rackspace Monitoring)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"RackspaceBot\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PyAMF)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(YaBrowser)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Yandex Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+).* MRCHROME\") {\n\t\tset var.Family = \"Mail.ru Chromium Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(AOL) (\\d+)\\.(\\d+); AOLBuild (\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PodCruncher|Downcast)[ /]?(\\d+)\\.?(\\d+)?\\.?(\\d+)?\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \" (BoxNotes)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Slack_SSB)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Slack Desktop Client\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(HipChat)/?(\\d+)?\") {\n\t\tset var.Family = \"HipChat Desktop Client\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\b(MobileIron|FireWeb|Jasmine|ANTGalio|Midori|Fresco|Lobo|PaleMoon|Maxthon|Lynx|OmniWeb|Dillo|Camino|Demeter|Fluid|Fennec|Epiphany|Shiira|Sunrise|Spotify|Flock|Netscape|Lunascape|WebPilot|NetFront|Netfront|Konqueror|SeaMonkey|Kazehakase|Vienna|Iceape|Iceweasel|IceWeasel|Iron|K-Meleon|Sleipnir|Galeon|GranParadiso|Opera Mini|iCab|NetNewsWire|ThunderBrowse|Iris|UP\\.Browser|Bunjalloo|Google Earth|Raven for Mac|Openwave|MacOutlook|Electron|OktaMobile)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Microsoft Office Outlook 12\\.\\d+\\.\\d+|MSOffice 12\") {\n\t\tset var.Family = \"Outlook\";\n\t\tset var.Major = \"2007\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Microsoft Outlook 14\\.\\d+\\.\\d+|MSOffice 14\") {\n\t\tset var.Family = \"Outlook\";\n\t\tset var.Major = \"2010\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Microsoft Outlook 15\\.\\d+\\.\\d+\") {\n\t\tset var.Family = \"Outlook\";\n\t\tset var.Major = \"2013\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Microsoft Outlook (?:Mail )?16\\.\\d+\\.\\d+\") {\n\t\tset var.Family = \"Outlook\";\n\t\tset var.Major = \"2016\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"Outlook-Express\\/7\\.0.*\") {\n\t\tset var.Family = \"Windows Live Mail\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Airmail) (\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Thunderbird)/(\\d+)\\.(\\d+)(?:\\.(\\d+(?:pre)?))?\") {\n\t\tset var.Family = \"Thunderbird\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Postbox)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Postbox\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Barca(?:Pro)?)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Barca\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Lotus-Notes)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Lotus Notes\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Vivaldi)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Edge)/(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(brave)/(\\d+)\\.(\\d+)\\.(\\d+) Chrome\") {\n\t\tset var.Family = \"Brave\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Chrome)/(\\d+)\\.(\\d+)\\.(\\d+)[\\d.]* Iron[^/]\") {\n\t\tset var.Family = \"Iron\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\b(Dolphin)(?: |HDCN/|/INT\\-)(\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(HeadlessChrome)(?:/(\\d+)\\.(\\d+)\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Evolution)/(\\d+)\\.(\\d+)\\.(\\d+\\.\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(RCM CardDAV plugin)/(\\d+)\\.(\\d+)\\.(\\d+(?:-dev)?)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(bingbot|Bolt|AdobeAIR|Jasmine|IceCat|Skyfire|Midori|Maxthon|Lynx|Arora|IBrowse|Dillo|Camino|Shiira|Fennec|Phoenix|Flock|Netscape|Lunascape|Epiphany|WebPilot|Opera Mini|Opera|NetFront|Netfront|Konqueror|Googlebot|SeaMonkey|Kazehakase|Vienna|Iceape|Iceweasel|IceWeasel|Iron|K-Meleon|Sleipnir|Galeon|GranParadiso|iCab|iTunes|MacAppStore|NetNewsWire|Space Bison|Stainless|Orca|Dolfin|BOLT|Minimo|Tizen Browser|Polaris|Abrowser|Planetweb|ICE Browser|mDolphin|qutebrowser|Otter|QupZilla|MailBar|kmail2|YahooMobileMail|ExchangeWebServices|ExchangeServicesClient|Dragon|Outlook-iOS-Android)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Chromium|Chrome)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(IEMobile)[ /](\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"IE Mobile\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(BacaBerita App)\\/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(bPod|Pocket Casts|Player FM)$\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(AlexaMediaPlayer|VLC)/(\\d+)\\.(\\d+)\\.([^.\\s]+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(AntennaPod|WMPlayer|Zune|Podkicker|Radio|ExoPlayerDemo|Overcast|PocketTunes|NSPlayer|okhttp|DoggCatcher|QuickNews|QuickTime|Peapod|Podcasts|GoldenPod|VLC|Spotify|Miro|MediaGo|Juice|iPodder|gPodder|Banshee)/(\\d+)\\.(\\d+)\\.?(\\d+)?\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Peapod|Liferea)/([^.\\s]+)\\.([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(bPod|Player FM) BMID/(\\S+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Podcast ?Addict)/v(\\d+) \") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Podcast ?Addict) \") {\n\t\tset var.Family = \"PodcastAddict\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Replay) AV\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(VOX) Music Player\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(CITA) RSS Aggregator/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Pocket Casts)$\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Player FM)$\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(LG Player|Doppler|FancyMusic|MediaMonkey|Clementine) (\\d+)\\.(\\d+)\\.?([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(philpodder)/(\\d+)\\.(\\d+)\\.?([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Player FM|Pocket Casts|DoggCatcher|Spotify|MediaMonkey|MediaGo|BashPodder)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(QuickTime)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Kinoma)(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Fancy) Cloud Music (\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"FancyMusic\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"EspnDownloadManager\") {\n\t\tset var.Family = \"ESPN\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(ESPN) Radio (\\d+)\\.(\\d+)\\.?(\\d+)? ?(?:rv:(\\d+))? \") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(podracer|jPodder) v ?(\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(ZDM)/(\\d+)\\.(\\d+)[; ]?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Zune|BeyondPod) (\\d+)\\.?(\\d+)?[\\);]\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(WMPlayer)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Lavf)\") {\n\t\tset var.Family = \"WMPlayer\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(RSSRadio)[ /]?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(RSS_Radio) (\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"RSSRadio\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Podkicker) \\S+/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Podkicker\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(HTC) Streaming Player \\S+ / \\S+ / \\S+ / (\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Stitcher)/iOS\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Stitcher)/Android\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(VLC) .*version (\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \" (VLC) for\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(vlc)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"VLC\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(foobar)\\S+/([^.\\s]+)\\.([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Clementine)\\S+ ([^.\\s]+)\\.([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(amarok)/([^.\\s]+)\\.([^.\\s]+)?\\.?([^.\\s]+)?\") {\n\t\tset var.Family = \"Amarok\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Custom)-Feed Reader\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iRider|Crazy Browser|SkipStone|iCab|Lunascape|Sleipnir|Maemo Browser) (\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iCab|Lunascape|Opera|Android|Jasmine|Polaris|Microsoft SkyDriveSync|The Bat!) (\\d+)\\.(\\d+)\\.?(\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Kindle)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Android) Donut\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"1\";\n\t\tset var.Minor=\"2\";\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Android) Eclair\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"2\";\n\t\tset var.Minor=\"1\";\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Android) Froyo\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"2\";\n\t\tset var.Minor=\"2\";\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Android) Gingerbread\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"2\";\n\t\tset var.Minor=\"3\";\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Android) Honeycomb\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"3\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MSIE) (\\d+)\\.(\\d+).*XBLWP7\") {\n\t\tset var.Family = \"IE Large Screen\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Nextcloud)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(mirall)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(ownCloud-android)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Owncloud\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Obigo)InternetBrowser\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Obigo)\\-Browser\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Obigo|OBIGO)[^\\d]*(\\d+)(?:.(\\d+))?\") {\n\t\tset var.Family = \"Obigo\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(MAXTHON|Maxthon) (\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Maxthon\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Maxthon|MyIE2|Uzbl|Shiira)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"0\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(BrowseX) \\((\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(NCSA_Mosaic)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"NCSA Mosaic\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(POLARIS)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Polaris\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Embider)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Polaris\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(BonEcho)/(\\d+)\\.(\\d+)\\.?([ab]?\\d+)?\") {\n\t\tset var.Family = \"Bon Echo\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPhone|iPad).+Version/(\\d+)\\.(\\d+)(?:\\.(\\d+))?.*[ +]Safari\") {\n\t\tset var.Family = \"Mobile Safari\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPod touch|iPhone|iPad);.*CPU.*OS[ +](\\d+)_(\\d+)(?:_(\\d+))?.* AppleNews\\/\\d+\\.\\d+\\.\\d+?\") {\n\t\tset var.Family = \"Mobile Safari UI/WKWebView\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPhone|iPad).+Version/(\\d+)\\.(\\d+)(?:\\.(\\d+))?\") {\n\t\tset var.Family = \"Mobile Safari UI/WKWebView\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPod touch|iPhone|iPad);.*CPU.*OS[ +](\\d+)_(\\d+)(?:_(\\d+))?.*Mobile.*[ +]Safari\") {\n\t\tset var.Family = \"Mobile Safari\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPod touch|iPhone|iPad);.*CPU.*OS[ +](\\d+)_(\\d+)(?:_(\\d+))?.*Mobile\") {\n\t\tset var.Family = \"Mobile Safari UI/WKWebView\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPhone|iPad).* Safari\") {\n\t\tset var.Family = \"Mobile Safari\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(iPod|iPhone|iPad)\") {\n\t\tset var.Family = \"Mobile Safari UI/WKWebView\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Outlook-iOS)/\\d+\\.\\d+\\.prod\\.iphone \\((\\d+)\\.(\\d+)\\.(\\d+)\\)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(AvantGo) (\\d+).(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(OneBrowser)/(\\d+).(\\d+)\") {\n\t\tset var.Family = \"ONE Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Avant)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"1\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(QtCarBrowser)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"1\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(iBrowser/Mini)(\\d+).(\\d+)\") {\n\t\tset var.Family = \"iBrowser Mini\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(iBrowser|iRAPP)/(\\d+).(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Nokia)\") {\n\t\tset var.Family = \"Nokia Services (WAP) Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(NokiaBrowser)/(\\d+)\\.(\\d+).(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Nokia Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(NokiaBrowser)/(\\d+)\\.(\\d+).(\\d+)\") {\n\t\tset var.Family = \"Nokia Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(NokiaBrowser)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Nokia Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(BrowserNG)/(\\d+)\\.(\\d+).(\\d+)\") {\n\t\tset var.Family = \"Nokia Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Series60)/5\\.0\") {\n\t\tset var.Family = \"Nokia Browser\";\n\t\tset var.Major = \"7\";\n\t\tset var.Minor=\"0\";\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Series60)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Nokia OSS Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(S40OviBrowser)/(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Ovi Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Nokia)[EN]?(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PlayBook).+RIM Tablet OS (\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"BlackBerry WebKit\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Black[bB]erry|BB10).+Version/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"BlackBerry WebKit\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Black[bB]erry)\\s?(\\d+)\") {\n\t\tset var.Family = \"BlackBerry\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(OmniWeb)/v(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Blazer)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Palm Blazer\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Pre)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Palm Pre\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(ELinks)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(ELinks) \\((\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Links) \\((\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(QtWeb) Internet Browser/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(PhantomJS)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(AppleWebKit)/(\\d+)\\.?(\\d+)?\\+ .* Safari\") {\n\t\tset var.Family = \"WebKit Nightly\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Version)/(\\d+)\\.(\\d+)(?:\\.(\\d+))?.*Safari/\") {\n\t\tset var.Family = \"Safari\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Safari)/\\d+\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(OLPC)/Update(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(OLPC)/Update()\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = \"0\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(SEMC\\-Browser)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Teleca)\") {\n\t\tset var.Family = \"Teleca Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Phantom)/V(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Phantom Browser\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Trident)/(7|8)\\.(0)\") {\n\t\tset var.Family = \"IE\";\n\t\tset var.Major = \"11\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Trident)/(6)\\.(0)\") {\n\t\tset var.Family = \"IE\";\n\t\tset var.Major = \"10\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Trident)/(5)\\.(0)\") {\n\t\tset var.Family = \"IE\";\n\t\tset var.Major = \"9\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Trident)/(4)\\.(0)\") {\n\t\tset var.Family = \"IE\";\n\t\tset var.Major = \"8\";\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Espial)/(\\d+)(?:\\.(\\d+))?(?:\\.(\\d+))?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(AppleWebKit)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Apple Mail\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Firefox)/(\\d+)\\.(\\d+)(pre|[ab]\\d+[a-z]*)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"([MS]?IE) (\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"IE\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(python-requests)/(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Python Requests\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"\\b(Windows-Update-Agent|Microsoft-CryptoAPI|SophosUpdateManager|SophosAgent|Debian APT-HTTP|Ubuntu APT-HTTP|libcurl-agent|libwww-perl|urlgrabber|curl|PycURL|Wget|aria2|Axel|OpenBSD ftp|lftp|jupdate)(?:[ /](\\d+)(?:\\.(\\d+)(?:\\.(\\d+))?)?)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Java)[/ ]{0,1}\\d+\\.(\\d+)\\.(\\d+)[_-]*([a-zA-Z0-9]+)*\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Cyberduck)/(\\d+)\\.(\\d+)\\.(\\d+)(?:\\.\\d+)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(S3 Browser) (\\d+)-(\\d+)-(\\d+)(?:\\s*http://s3browser\\.com)?\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(rclone)/v(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Roku)/DVP-(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"(Kurio)\\/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = \"Kurio App\";\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t} else if (req.http.User-Agent ~ \"^(Box(?: Sync)?)/(\\d+)\\.(\\d+)\\.(\\d+)\") {\n\t\tset var.Family = re.group.1;\n\t\tset var.Major = re.group.2;\n\t\tset var.Minor = re.group.3;\n\t\tset var.Patch = re.group.4;\n\t}\n  set req.http.useragent_parser_family=var.Family;\n  set req.http.useragent_parser_major=var.Major;\n  set req.http.useragent_parser_minor=var.Minor;\n  set req.http.useragent_parser_patch=var.Patch;\n}"
  },
  "reqUrl": "/v3/polyfill.js?features=IntersectionObserver%2Cfetch&callback=&zebra=striped",
  "reqMethod": "GET",
  "purgeFirst": true,
  "enableCluster": false,
  "enableShield": false
}
</script>

\----- The part below is not finished, probably no reason to read it -----

 User-Agent headers vary a lot and new values are seen everyday, however most of the contents in a header is not of importance to polyfill.io, we only need to know the family and the major, minor and patch version of the user-agent. Versions 1 and 2 of polyfill.io had an endpoint which would take the user-agent as a query parameter and return a normalised user-agent header in the format \`user-agent-family/major-version.minor-version.patch-version.\`.

E.G:

```
http https://polyfill.io/v2/normalizeUa\?ua\=Mozilla/5.0%20\(Macintosh\;%20Intel%20Mac%20OS%20X%2010_12_6\)%20AppleWebKit/537.36%20\(KHTML,%20like%20Gecko\)%20Chrome/71.0.3578.98%20Safari/537.36 -p h | grep "Normalized-User-Agent"
```

```
Normalized-User-Agent: chrome/71.0.0
```

Having it as an endpoint on the backend server required custom <abbr title="Varnish Configuration Language">VCL</abbr> which rewrites requests to the polyfill bundle endpoints without a normalised user-agent header to instead go to the normalising endpoint and when it got a response, would issue a <abbr title="Varnish Configuration Language">VCL</abbr> restart for the origin request but with the addition of the normalised user-agent header.

Having restarts be a core part of the system makes the normal request to response flow become more complicated.

In version 3 of polyfill.io we decided to move the user-agent normalisation code from the backend and into the CDN via <abbr title="Varnish Configuration Language">VCL</abbr>. This bought back the simple request to response flow and meant that a single request to the CDN would make at most only one request to the backend. This alone wouldn't make a big difference to the cache-hit ratio, what did make a big difference was taking the normalised user agent and checking if it is a user-agent that polyfill.io supports. Polyfill.io supports 16 user-agents, if the user-agent is not one of those 16 we set the value to `other/0.0.0`. This meant that the url used for identifying a polyfill-bundle contained a user-agent family that was one we supported, or the value `other`, this is extremely useful for increasing the cache-hit ratio because if the user-agent is unsupported, it will be served the same bundle as any other unsupported user-agent so we might as well have that bundle stored under a url that would serve both requests.

The user agents that are supported are:

* Chrome
* Android
* BlackBerry
* Edge
* Edge Mobile
* Internet Explorer
* Internet Explorer Mobile
* Safari
* iOS Safari
* iOS Chrome
* Firefox
* Firefox Mobile
* Opera
* Opera Mobile
* Opera Mini
* Samsung Mobile

## Normalising the API.

TODO
